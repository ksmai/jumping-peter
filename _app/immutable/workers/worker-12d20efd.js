(function(){"use strict";const ve=function(){var r={},n=-1,y,l,b,d,C,U,S=12,D=5003,B,u=S,F,L=1<<S,W=[],ae=[],z=D,Q=0,Y=!1,J,M,k,N=0,X=0,$=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],O,ie=[],j=r.LZWEncoder=function(m,o,e,s){y=m,l=o,b=e,d=Math.max(2,s)},ne=function(m,o){ie[O++]=m,O>=254&&q(o)},H=function(m){ee(z),Q=M+2,Y=!0,V(M,m)},ee=function(m){for(var o=0;o<m;++o)W[o]=-1},E=r.compress=function(m,o){var e,s,A,_,I,g,a;for(J=m,Y=!1,B=J,F=K(B),M=1<<m-1,k=M+1,Q=M+2,O=0,_=re(),a=0,e=z;e<65536;e*=2)++a;a=8-a,g=z,ee(g),V(M,o);e:for(;(A=re())!=n;){if(e=(A<<u)+_,s=A<<a^_,W[s]==e){_=ae[s];continue}else if(W[s]>=0){I=g-s,s===0&&(I=1);do if((s-=I)<0&&(s+=g),W[s]==e){_=ae[s];continue e}while(W[s]>=0)}V(_,o),_=A,Q<L?(ae[s]=Q++,W[s]=e):H(o)}V(_,o),V(k,o)};r.encode=function(m){m.writeByte(d),C=y*l,U=0,E(d+1,m),m.writeByte(0)};var q=function(m){O>0&&(m.writeByte(O),m.writeBytes(ie,0,O),O=0)},K=function(m){return(1<<m)-1},re=function(){if(C===0)return n;--C;var m=b[U++];return m&255},V=function(m,o){for(N&=$[X],X>0?N|=m<<X:N=m,X+=B;X>=8;)ne(N&255,o),N>>=8,X-=8;if((Q>F||Y)&&(Y?(F=K(B=J),Y=!1):(++B,B==u?F=L:F=K(B))),m==k){for(;X>0;)ne(N&255,o),N>>=8,X-=8;q(o)}};return j.apply(this,arguments),r},ue=function(){var r={},n=256,y=499,l=491,b=487,d=503,C=3*d,U=n-1,S=4,D=100,B=16,u=1<<B,F=10,L=10,W=u>>L,ae=u<<F-L,z=n>>3,Q=6,Y=1<<Q,J=z*Y,M=30,k=10,N=1<<k,X,$=8,O=1<<$,ie=k+$,j=1<<ie,ne,H,ee,E,q=[],K=[],re=[],V=[],R=r.NeuQuant=function(a,f,p){var c,v;for(ne=a,H=f,ee=p,E=new Array(n),c=0;c<n;c++)E[c]=new Array(4),v=E[c],v[0]=v[1]=v[2]=(c<<S+8)/n,re[c]=u/n,K[c]=0},m=function(){for(var a=[],f=new Array(n),p=0;p<n;p++)f[E[p][3]]=p;for(var c=0,v=0;v<n;v++){var t=f[v];a[c++]=E[t][0],a[c++]=E[t][1],a[c++]=E[t][2]}return a},o=function(){var a,f,p,c,v,t,i,h;for(i=0,h=0,a=0;a<n;a++){for(v=E[a],p=a,c=v[1],f=a+1;f<n;f++)t=E[f],t[1]<c&&(p=f,c=t[1]);if(t=E[p],a!=p&&(f=t[0],t[0]=v[0],v[0]=f,f=t[1],t[1]=v[1],v[1]=f,f=t[2],t[2]=v[2],v[2]=f,f=t[3],t[3]=v[3],v[3]=f),c!=i){for(q[i]=h+a>>1,f=i+1;f<c;f++)q[f]=a;i=c,h=a}}for(q[i]=h+U>>1,f=i+1;f<256;f++)q[f]=U},e=function(){var a,f,p,c,v,t,i,h,x,P,Z,T,G,ce;for(H<C&&(ee=1),X=30+(ee-1)/3,T=ne,G=0,ce=H,Z=H/(3*ee),P=Z/D|0,h=N,t=J,i=t>>Q,i<=1&&(i=0),a=0;a<i;a++)V[a]=h*((i*i-a*a)*O/(i*i));for(H<C?x=3:H%y!==0?x=3*y:H%l!==0?x=3*l:H%b!==0?x=3*b:x=3*d,a=0;a<Z;)if(p=(T[G+0]&255)<<S,c=(T[G+1]&255)<<S,v=(T[G+2]&255)<<S,f=I(p,c,v),_(h,f,p,c,v),i!==0&&A(i,f,p,c,v),G+=x,G>=ce&&(G-=H),a++,P===0&&(P=1),a%P===0)for(h-=h/X,t-=t/M,i=t>>Q,i<=1&&(i=0),f=0;f<i;f++)V[f]=h*((i*i-f*f)*O/(i*i))};r.map=function(a,f,p){var c,v,t,i,h,x,P;for(h=1e3,P=-1,c=q[f],v=c-1;c<n||v>=0;)c<n&&(x=E[c],t=x[1]-f,t>=h?c=n:(c++,t<0&&(t=-t),i=x[0]-a,i<0&&(i=-i),t+=i,t<h&&(i=x[2]-p,i<0&&(i=-i),t+=i,t<h&&(h=t,P=x[3])))),v>=0&&(x=E[v],t=f-x[1],t>=h?v=-1:(v--,t<0&&(t=-t),i=x[0]-a,i<0&&(i=-i),t+=i,t<h&&(i=x[2]-p,i<0&&(i=-i),t+=i,t<h&&(h=t,P=x[3]))));return P},r.process=function(){return e(),s(),o(),m()};var s=function(){var a;for(a=0;a<n;a++)E[a][0]>>=S,E[a][1]>>=S,E[a][2]>>=S,E[a][3]=a},A=function(a,f,p,c,v){var t,i,h,x,P,Z,T;for(h=f-a,h<-1&&(h=-1),x=f+a,x>n&&(x=n),t=f+1,i=f-1,Z=1;t<x||i>h;){if(P=V[Z++],t<x){T=E[t++];try{T[0]-=P*(T[0]-p)/j,T[1]-=P*(T[1]-c)/j,T[2]-=P*(T[2]-v)/j}catch{}}if(i>h){T=E[i--];try{T[0]-=P*(T[0]-p)/j,T[1]-=P*(T[1]-c)/j,T[2]-=P*(T[2]-v)/j}catch{}}}},_=function(a,f,p,c,v){var t=E[f];t[0]-=a*(t[0]-p)/N,t[1]-=a*(t[1]-c)/N,t[2]-=a*(t[2]-v)/N},I=function(a,f,p){var c,v,t,i,h,x,P,Z,T,G;for(Z=~(1<<31),T=Z,x=-1,P=x,c=0;c<n;c++)G=E[c],v=G[0]-a,v<0&&(v=-v),t=G[1]-f,t<0&&(t=-t),v+=t,t=G[2]-p,t<0&&(t=-t),v+=t,v<Z&&(Z=v,x=c),i=v-(K[c]>>B-S),i<T&&(T=i,P=c),h=re[c]>>L,re[c]-=h,K[c]+=h<<F;return re[x]+=W,K[x]-=ae,P};return R.apply(this,arguments),r},le=function(){for(var r=0,n={};r<256;r++)n[r]=String.fromCharCode(r);function y(){this.bin=[]}y.prototype.getData=function(){for(var o="",e=this.bin.length,s=0;s<e;s++)o+=n[this.bin[s]];return o},y.prototype.writeByte=function(o){this.bin.push(o)},y.prototype.writeUTFBytes=function(o){for(var e=o.length,s=0;s<e;s++)this.writeByte(o.charCodeAt(s))},y.prototype.writeBytes=function(o,e,s){for(var A=s||o.length,_=e||0;_<A;_++)this.writeByte(o[_])};var l={},b,d,C=null,U,S=-1,D=0,B=!1,u,F,L,W,ae,z,Q=[],Y=7,J=-1,M=!1,k=!0,N=!1,X=10,$="Generated by jsgif (https://github.com/antimatter15/jsgif/)";l.setDelay=function(e){D=Math.round(e/10)},l.setDispose=function(e){e>=0&&(J=e)},l.setRepeat=function(e){e>=0&&(S=e)},l.setTransparent=function(e){C=e},l.setComment=function(e){$=e},l.addFrame=function(e,s){if(e===null||!B||u===null)throw new Error("Please call start method before calling addFrame");var A=!0;try{s?e instanceof ImageData?(F=e.data,(!sizeset||b!=e.width||d!=e.height)&&ie(e.width,e.height)):e instanceof Uint8ClampedArray?e.length==b*d*4?F=e:(console.log("Please set the correct size: ImageData length mismatch"),A=!1):(console.log("Please provide correct input"),A=!1):(F=e.getImageData(0,0,e.canvas.width,e.canvas.height).data,N||ie(e.canvas.width,e.canvas.height)),H(),j(),k&&(K(),V(),S>=0&&re()),ee(),$!==""&&E(),q(),k||V(),m(),k=!1}catch{A=!1}return A},l.download=function(e){if(u===null||M==!1)console.log("Please call start method and add frames and call finish method before calling download");else{e=e!==void 0?e.endsWith(".gif")?e:e+".gif":"download.gif";var s=document.createElement("a");s.download=e,s.href=URL.createObjectURL(new Blob([new Uint8Array(u.bin)],{type:"image/gif"})),s.click()}},l.finish=function(){if(!B)return!1;var e=!0;B=!1;try{u.writeByte(59),M=!0}catch{e=!1}return e};var O=function(){U=0,F=null,L=null,W=null,z=null,M=!1,k=!0};l.setFrameRate=function(e){e!=15&&(D=Math.round(100/e))},l.setQuality=function(e){e<1&&(e=1),X=e};var ie=l.setSize=function(e,s){B&&!k||(b=e,d=s,b<1&&(b=320),d<1&&(d=240),N=!0)};l.start=function(){O();var e=!0;M=!1,u=new y;try{u.writeUTFBytes("GIF89a")}catch{e=!1}return B=e},l.cont=function(){O();var e=!0;return M=!1,u=new y,B=e};var j=function(){var e=L.length,s=e/3;W=[];var A=new ue(L,e,X);z=A.process();for(var _=0,I=0;I<s;I++){var g=A.map(L[_++]&255,L[_++]&255,L[_++]&255);Q[g]=!0,W[I]=g}L=null,ae=8,Y=7,C!==null&&(U=ne(C))},ne=function(e){if(z===null)return-1;for(var s=(e&16711680)>>16,A=(e&65280)>>8,_=e&255,I=0,g=256*256*256,a=z.length,f=0;f<a;){var p=s-(z[f++]&255),c=A-(z[f++]&255),v=_-(z[f]&255),t=p*p+c*c+v*v,i=f/3;Q[i]&&t<g&&(g=t,I=i),f++}return I},H=function(){var e=b,s=d;L=[];for(var A=F,_=0,I=0;I<s;I++)for(var g=0;g<e;g++){var a=I*e*4+g*4;L[_++]=A[a],L[_++]=A[a+1],L[_++]=A[a+2]}},ee=function(){u.writeByte(33),u.writeByte(249),u.writeByte(4);var e,s;C===null?(e=0,s=0):(e=1,s=2),J>=0&&(s=J&7),s<<=2,u.writeByte(0|s|0|e),R(D),u.writeByte(U),u.writeByte(0)},E=function(){u.writeByte(33),u.writeByte(254),u.writeByte($.length),u.writeUTFBytes($),u.writeByte(0)},q=function(){u.writeByte(44),R(0),R(0),R(b),R(d),k?u.writeByte(0):u.writeByte(128|Y)},K=function(){R(b),R(d),u.writeByte(240|Y),u.writeByte(0),u.writeByte(0)},re=function(){u.writeByte(33),u.writeByte(255),u.writeByte(11),u.writeUTFBytes("NETSCAPE2.0"),u.writeByte(3),u.writeByte(1),R(S),u.writeByte(0)},V=function(){u.writeBytes(z);for(var e=3*256-z.length,s=0;s<e;s++)u.writeByte(0)},R=function(e){u.writeByte(e&255),u.writeByte(e>>8&255)},m=function(){var e=new ve(b,d,W,ae);e.encode(u)};return l.stream=function(){return u},l.setProperties=function(e,s){B=e,k=s},l};function se(r,n,y){const l=r.createShader(n);return l?(r.shaderSource(l,y),r.compileShader(l),r.getShaderParameter(l,r.COMPILE_STATUS)?l:(console.error(r.getShaderInfoLog(l)),r.deleteShader(l),null)):null}function de(r,n,y){const l=se(r,r.VERTEX_SHADER,n);if(!l)return null;const b=se(r,r.FRAGMENT_SHADER,y);if(!b)return r.deleteShader(l),null;const d=r.createProgram();return d?(r.attachShader(d,l),r.attachShader(d,b),r.linkProgram(d),r.getProgramParameter(d,r.LINK_STATUS)?(r.detachShader(d,b),r.detachShader(d,l),r.deleteShader(b),r.deleteShader(l),d):(console.error(r.getProgramInfoLog(d)),r.deleteProgram(d),r.deleteShader(b),r.deleteShader(l),null)):null}function he(r,n,y,l,b){const d=de(r,n,y);if(!d)return null;const C={program:d,attributeLocations:{},uniformLocations:{}};for(const U of l){const S=r.getAttribLocation(d,U);C.attributeLocations[U]=S}for(const U of b){const S=r.getUniformLocation(d,U);if(!S)return r.deleteProgram(d),null;C.uniformLocations[U]=S}return C}const me=`#version 300 es

in vec2 a_clipCoord;
uniform float u_percentage;
uniform vec2 u_velocity;

in vec2 a_texCoord;
out vec2 v_texCoord;

void main() {
  gl_Position = vec4(a_clipCoord, 0, 1);
  vec2 offset = u_velocity * u_percentage;
  // invert y-axis as it's direction is different in webgl/gif
  v_texCoord = vec2(a_texCoord.x - offset.x, 1.0 - a_texCoord.y + offset.y);
}
`,pe=`#version 300 es

precision highp float;

in vec2 v_texCoord;
uniform sampler2D u_image;

out vec4 outColor;

void main() {
  outColor = texture(u_image, v_texCoord);
}
`;let te={initialized:!1};function xe(r){if(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.REPEAT),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.REPEAT),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),te.initialized)return;const n=he(r,me,pe,["a_texCoord","a_clipCoord"],["u_percentage","u_velocity","u_image"]);if(!n)throw new Error("Failed to compile the program");const y=r.createVertexArray();if(!y)throw new Error("Failed to create vertex array object");r.bindVertexArray(y);const l=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,l),r.bufferData(r.ARRAY_BUFFER,new Float32Array([-1,-1,0,1,-1,1,0,0,1,-1,1,1,1,1,1,0]),r.STATIC_DRAW),r.enableVertexAttribArray(n.attributeLocations.a_clipCoord),r.vertexAttribPointer(n.attributeLocations.a_clipCoord,2,r.FLOAT,!1,4*4,0),r.enableVertexAttribArray(n.attributeLocations.a_texCoord),r.vertexAttribPointer(n.attributeLocations.a_texCoord,2,r.FLOAT,!1,4*4,2*4),te={initialized:!0,program:n,vao:y}}function we(r,n,y){if(!te.initialized)throw new Error("Animation has not been initialized: extreme-speed");return r.useProgram(te.program.program),r.bindVertexArray(te.vao),r.uniform1i(te.program.uniformLocations.u_image,0),r.uniform1f(te.program.uniformLocations.u_percentage,n),r.uniform2f(te.program.uniformLocations.u_velocity,y.velocityX,y.velocityY),r.drawArrays(r.TRIANGLE_STRIP,0,4),!0}const fe=new OffscreenCanvas(128,128),w=fe.getContext("webgl2");let oe=null;self.onmessage=async r=>{const n=r.data;if(!w){const D={id:n.id,type:"error",error:"webgl2 is not supported"};postMessage(D);return}const l=await(await fetch(n.gif.imageUrl)).blob(),b=await createImageBitmap(l);oe&&w.deleteTexture(oe),oe=w.createTexture(),w.activeTexture(w.TEXTURE0+0),w.bindTexture(w.TEXTURE_2D,oe),w.texImage2D(w.TEXTURE_2D,0,w.RGBA,w.RGBA,w.UNSIGNED_BYTE,b),fe.width=n.gif.width,fe.height=n.gif.height;try{switch(n.animation.name){case"extreme-speed":xe(w);break;default:(D=>{throw new Error("Unknown animation")})(n.animation.name)}}catch(D){const B={id:n.id,type:"error",error:String(D)};postMessage(B);return}const d=new le;d.setRepeat(0),d.setDelay(n.gif.delayMs),d.setSize(n.gif.width,n.gif.height),d.start();for(let D=0;D<=n.gif.totalFrames;++D){w.viewport(0,0,w.canvas.width,w.canvas.height),w.clearColor(0,0,0,0),w.clear(w.COLOR_BUFFER_BIT);try{switch(n.animation.name){case"extreme-speed":we(w,D/n.gif.totalFrames,n.animation);break;default:(u=>{throw new Error("Unknown animation")})(n.animation.name)}}catch(u){const F={id:n.id,type:"error",error:String(u)};postMessage(F);return}const B=new Uint8ClampedArray(w.drawingBufferWidth*w.drawingBufferHeight*4);w.readPixels(0,0,w.drawingBufferWidth,w.drawingBufferHeight,w.RGBA,w.UNSIGNED_BYTE,B),d.addFrame(B,!0)}d.finish();const C=d.stream().getData(),U="data:image/gif;base64,"+btoa(C),S={id:n.id,type:"success",dataUri:U};postMessage(S)}})();
