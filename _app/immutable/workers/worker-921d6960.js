(function(){"use strict";const de=function(){var e={},a=-1,l,d,y,m,S,L,g=12,F=5003,A,v=g,U,D=1<<g,W=[],ie=[],X=F,j=0,Y=!1,J,N,M,z=0,k=0,ee=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],O,oe=[],Z=e.LZWEncoder=function(p,n,r,s){l=p,d=n,y=r,m=Math.max(2,s)},ne=function(p,n){oe[O++]=p,O>=254&&q(n)},H=function(p){re(X),j=N+2,Y=!0,V(N,p)},re=function(p){for(var n=0;n<p;++n)W[n]=-1},E=e.compress=function(p,n){var r,s,R,b,I,T,i;for(J=p,Y=!1,A=J,U=K(A),N=1<<p-1,M=N+1,j=N+2,O=0,b=te(),i=0,r=X;r<65536;r*=2)++i;i=8-i,T=X,re(T),V(N,n);e:for(;(R=te())!=a;){if(r=(R<<v)+b,s=R<<i^b,W[s]==r){b=ie[s];continue}else if(W[s]>=0){I=T-s,s===0&&(I=1);do if((s-=I)<0&&(s+=T),W[s]==r){b=ie[s];continue e}while(W[s]>=0)}V(b,n),b=R,j<D?(ie[s]=j++,W[s]=r):H(n)}V(b,n),V(M,n)};e.encode=function(p){p.writeByte(m),S=l*d,L=0,E(m+1,p),p.writeByte(0)};var q=function(p){O>0&&(p.writeByte(O),p.writeBytes(oe,0,O),O=0)},K=function(p){return(1<<p)-1},te=function(){if(S===0)return a;--S;var p=y[L++];return p&255},V=function(p,n){for(z&=ee[k],k>0?z|=p<<k:z=p,k+=A;k>=8;)ne(z&255,n),z>>=8,k-=8;if((j>U||Y)&&(Y?(U=K(A=J),Y=!1):(++A,A==v?U=D:U=K(A))),p==M){for(;k>0;)ne(z&255,n),z>>=8,k-=8;q(n)}};return Z.apply(this,arguments),e},me=function(){var e={},a=256,l=499,d=491,y=487,m=503,S=3*m,L=a-1,g=4,F=100,A=16,v=1<<A,U=10,D=10,W=v>>D,ie=v<<U-D,X=a>>3,j=6,Y=1<<j,J=X*Y,N=30,M=10,z=1<<M,k,ee=8,O=1<<ee,oe=M+ee,Z=1<<oe,ne,H,re,E,q=[],K=[],te=[],V=[],P=e.NeuQuant=function(i,f,_){var c,u;for(ne=i,H=f,re=_,E=new Array(a),c=0;c<a;c++)E[c]=new Array(4),u=E[c],u[0]=u[1]=u[2]=(c<<g+8)/a,te[c]=v/a,K[c]=0},p=function(){for(var i=[],f=new Array(a),_=0;_<a;_++)f[E[_][3]]=_;for(var c=0,u=0;u<a;u++){var t=f[u];i[c++]=E[t][0],i[c++]=E[t][1],i[c++]=E[t][2]}return i},n=function(){var i,f,_,c,u,t,o,h;for(o=0,h=0,i=0;i<a;i++){for(u=E[i],_=i,c=u[1],f=i+1;f<a;f++)t=E[f],t[1]<c&&(_=f,c=t[1]);if(t=E[_],i!=_&&(f=t[0],t[0]=u[0],u[0]=f,f=t[1],t[1]=u[1],u[1]=f,f=t[2],t[2]=u[2],u[2]=f,f=t[3],t[3]=u[3],u[3]=f),c!=o){for(q[o]=h+i>>1,f=o+1;f<c;f++)q[f]=i;o=c,h=i}}for(q[o]=h+L>>1,f=o+1;f<256;f++)q[f]=L},r=function(){var i,f,_,c,u,t,o,h,w,B,Q,C,G,ve;for(H<S&&(re=1),k=30+(re-1)/3,C=ne,G=0,ve=H,Q=H/(3*re),B=Q/F|0,h=z,t=J,o=t>>j,o<=1&&(o=0),i=0;i<o;i++)V[i]=h*((o*o-i*i)*O/(o*o));for(H<S?w=3:H%l!==0?w=3*l:H%d!==0?w=3*d:H%y!==0?w=3*y:w=3*m,i=0;i<Q;)if(_=(C[G+0]&255)<<g,c=(C[G+1]&255)<<g,u=(C[G+2]&255)<<g,f=I(_,c,u),b(h,f,_,c,u),o!==0&&R(o,f,_,c,u),G+=w,G>=ve&&(G-=H),i++,B===0&&(B=1),i%B===0)for(h-=h/k,t-=t/N,o=t>>j,o<=1&&(o=0),f=0;f<o;f++)V[f]=h*((o*o-f*f)*O/(o*o))};e.map=function(i,f,_){var c,u,t,o,h,w,B;for(h=1e3,B=-1,c=q[f],u=c-1;c<a||u>=0;)c<a&&(w=E[c],t=w[1]-f,t>=h?c=a:(c++,t<0&&(t=-t),o=w[0]-i,o<0&&(o=-o),t+=o,t<h&&(o=w[2]-_,o<0&&(o=-o),t+=o,t<h&&(h=t,B=w[3])))),u>=0&&(w=E[u],t=f-w[1],t>=h?u=-1:(u--,t<0&&(t=-t),o=w[0]-i,o<0&&(o=-o),t+=o,t<h&&(o=w[2]-_,o<0&&(o=-o),t+=o,t<h&&(h=t,B=w[3]))));return B},e.process=function(){return r(),s(),n(),p()};var s=function(){var i;for(i=0;i<a;i++)E[i][0]>>=g,E[i][1]>>=g,E[i][2]>>=g,E[i][3]=i},R=function(i,f,_,c,u){var t,o,h,w,B,Q,C;for(h=f-i,h<-1&&(h=-1),w=f+i,w>a&&(w=a),t=f+1,o=f-1,Q=1;t<w||o>h;){if(B=V[Q++],t<w){C=E[t++];try{C[0]-=B*(C[0]-_)/Z,C[1]-=B*(C[1]-c)/Z,C[2]-=B*(C[2]-u)/Z}catch{}}if(o>h){C=E[o--];try{C[0]-=B*(C[0]-_)/Z,C[1]-=B*(C[1]-c)/Z,C[2]-=B*(C[2]-u)/Z}catch{}}}},b=function(i,f,_,c,u){var t=E[f];t[0]-=i*(t[0]-_)/z,t[1]-=i*(t[1]-c)/z,t[2]-=i*(t[2]-u)/z},I=function(i,f,_){var c,u,t,o,h,w,B,Q,C,G;for(Q=~(1<<31),C=Q,w=-1,B=w,c=0;c<a;c++)G=E[c],u=G[0]-i,u<0&&(u=-u),t=G[1]-f,t<0&&(t=-t),u+=t,t=G[2]-_,t<0&&(t=-t),u+=t,u<Q&&(Q=u,w=c),o=u-(K[c]>>A-g),o<C&&(C=o,B=c),h=te[c]>>D,te[c]-=h,K[c]+=h<<U;return te[w]+=W,K[w]-=ie,B};return P.apply(this,arguments),e},le=function(){for(var e=0,a={};e<256;e++)a[e]=String.fromCharCode(e);function l(){this.bin=[]}l.prototype.getData=function(){for(var n="",r=this.bin.length,s=0;s<r;s++)n+=a[this.bin[s]];return n},l.prototype.writeByte=function(n){this.bin.push(n)},l.prototype.writeUTFBytes=function(n){for(var r=n.length,s=0;s<r;s++)this.writeByte(n.charCodeAt(s))},l.prototype.writeBytes=function(n,r,s){for(var R=s||n.length,b=r||0;b<R;b++)this.writeByte(n[b])};var d={},y,m,S=null,L,g=-1,F=0,A=!1,v,U,D,W,ie,X,j=[],Y=7,J=-1,N=!1,M=!0,z=!1,k=10,ee="Generated by jsgif (https://github.com/antimatter15/jsgif/)";d.setDelay=function(r){F=Math.round(r/10)},d.setDispose=function(r){r>=0&&(J=r)},d.setRepeat=function(r){r>=0&&(g=r)},d.setTransparent=function(r){S=r},d.setComment=function(r){ee=r},d.addFrame=function(r,s){if(r===null||!A||v===null)throw new Error("Please call start method before calling addFrame");var R=!0;try{s?r instanceof ImageData?(U=r.data,(!sizeset||y!=r.width||m!=r.height)&&oe(r.width,r.height)):r instanceof Uint8ClampedArray?r.length==y*m*4?U=r:(console.log("Please set the correct size: ImageData length mismatch"),R=!1):(console.log("Please provide correct input"),R=!1):(U=r.getImageData(0,0,r.canvas.width,r.canvas.height).data,z||oe(r.canvas.width,r.canvas.height)),H(),Z(),M&&(K(),V(),g>=0&&te()),re(),ee!==""&&E(),q(),M||V(),p(),M=!1}catch{R=!1}return R},d.download=function(r){if(v===null||N==!1)console.log("Please call start method and add frames and call finish method before calling download");else{r=r!==void 0?r.endsWith(".gif")?r:r+".gif":"download.gif";var s=document.createElement("a");s.download=r,s.href=URL.createObjectURL(new Blob([new Uint8Array(v.bin)],{type:"image/gif"})),s.click()}},d.finish=function(){if(!A)return!1;var r=!0;A=!1;try{v.writeByte(59),N=!0}catch{r=!1}return r};var O=function(){L=0,U=null,D=null,W=null,X=null,N=!1,M=!0};d.setFrameRate=function(r){r!=15&&(F=Math.round(100/r))},d.setQuality=function(r){r<1&&(r=1),k=r};var oe=d.setSize=function(r,s){A&&!M||(y=r,m=s,y<1&&(y=320),m<1&&(m=240),z=!0)};d.start=function(){O();var r=!0;N=!1,v=new l;try{v.writeUTFBytes("GIF89a")}catch{r=!1}return A=r},d.cont=function(){O();var r=!0;return N=!1,v=new l,A=r};var Z=function(){var r=D.length,s=r/3;W=[];var R=new me(D,r,k);X=R.process();for(var b=0,I=0;I<s;I++){var T=R.map(D[b++]&255,D[b++]&255,D[b++]&255);j[T]=!0,W[I]=T}D=null,ie=8,Y=7,S!==null&&(L=ne(S))},ne=function(r){if(X===null)return-1;for(var s=(r&16711680)>>16,R=(r&65280)>>8,b=r&255,I=0,T=256*256*256,i=X.length,f=0;f<i;){var _=s-(X[f++]&255),c=R-(X[f++]&255),u=b-(X[f]&255),t=_*_+c*c+u*u,o=f/3;j[o]&&t<T&&(T=t,I=o),f++}return I},H=function(){var r=y,s=m;D=[];for(var R=U,b=0,I=0;I<s;I++)for(var T=0;T<r;T++){var i=I*r*4+T*4;D[b++]=R[i],D[b++]=R[i+1],D[b++]=R[i+2]}},re=function(){v.writeByte(33),v.writeByte(249),v.writeByte(4);var r,s;S===null?(r=0,s=0):(r=1,s=2),J>=0&&(s=J&7),s<<=2,v.writeByte(0|s|0|r),P(F),v.writeByte(L),v.writeByte(0)},E=function(){v.writeByte(33),v.writeByte(254),v.writeByte(ee.length),v.writeUTFBytes(ee),v.writeByte(0)},q=function(){v.writeByte(44),P(0),P(0),P(y),P(m),M?v.writeByte(0):v.writeByte(128|Y)},K=function(){P(y),P(m),v.writeByte(240|Y),v.writeByte(0),v.writeByte(0)},te=function(){v.writeByte(33),v.writeByte(255),v.writeByte(11),v.writeUTFBytes("NETSCAPE2.0"),v.writeByte(3),v.writeByte(1),P(g),v.writeByte(0)},V=function(){v.writeBytes(X);for(var r=3*256-X.length,s=0;s<r;s++)v.writeByte(0)},P=function(r){v.writeByte(r&255),v.writeByte(r>>8&255)},p=function(){var r=new de(y,m,W,ie);r.encode(v)};return d.stream=function(){return v},d.setProperties=function(r,s){A=r,M=s},d};function ce(e,a,l){const d=e.createShader(a);return d?(e.shaderSource(d,l),e.compileShader(d),e.getShaderParameter(d,e.COMPILE_STATUS)?d:(console.error(e.getShaderInfoLog(d)),e.deleteShader(d),null)):null}function he(e,a,l){const d=ce(e,e.VERTEX_SHADER,a);if(!d)return null;const y=ce(e,e.FRAGMENT_SHADER,l);if(!y)return e.deleteShader(d),null;const m=e.createProgram();return m?(e.attachShader(m,d),e.attachShader(m,y),e.linkProgram(m),e.getProgramParameter(m,e.LINK_STATUS)?(e.detachShader(m,y),e.detachShader(m,d),e.deleteShader(y),e.deleteShader(d),m):(console.error(e.getProgramInfoLog(m)),e.deleteProgram(m),e.deleteShader(y),e.deleteShader(d),null)):null}function ue(e,a,l,d,y){const m=he(e,a,l);if(!m)return null;const S={program:m,attributeLocations:{},uniformLocations:{}};for(const L of d){const g=e.getAttribLocation(m,L);S.attributeLocations[L]=g}for(const L of y){const g=e.getUniformLocation(m,L);if(!g)return console.error(`Cannot get location of uniform: ${L}`),e.deleteProgram(m),null;S.uniformLocations[L]=g}return S}const xe=`#version 300 es

in vec2 a_clipCoord;
uniform float u_percentage;
uniform vec2 u_velocity;

in vec2 a_texCoord;
out vec2 v_texCoord;

void main() {
  gl_Position = vec4(a_clipCoord, 0, 1);
  vec2 offset = u_velocity * u_percentage;
  v_texCoord = vec2(a_texCoord.x - offset.x, a_texCoord.y - offset.y);
}
`,pe=`#version 300 es

precision highp float;

in vec2 v_texCoord;
uniform sampler2D u_image;

out vec4 outColor;

void main() {
  outColor = texture(u_image, v_texCoord);
}
`;let ae={initialized:!1};function _e(e){if(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),ae.initialized)return;const a=ue(e,xe,pe,["a_texCoord","a_clipCoord"],["u_percentage","u_velocity","u_image"]);if(!a)throw new Error("Failed to compile the program");const l=e.createVertexArray();if(!l)throw new Error("Failed to create vertex array object");e.bindVertexArray(l);const d=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,d),e.bufferData(e.ARRAY_BUFFER,new Float32Array([-1,-1,0,0,-1,1,0,1,1,-1,1,0,1,1,1,1]),e.STATIC_DRAW),e.enableVertexAttribArray(a.attributeLocations.a_clipCoord),e.vertexAttribPointer(a.attributeLocations.a_clipCoord,2,e.FLOAT,!1,4*4,0),e.enableVertexAttribArray(a.attributeLocations.a_texCoord),e.vertexAttribPointer(a.attributeLocations.a_texCoord,2,e.FLOAT,!1,4*4,2*4),ae={initialized:!0,program:a,vao:l}}function we(e,a,l){if(!ae.initialized)throw new Error("Animation has not been initialized: extreme-speed");return e.useProgram(ae.program.program),e.bindVertexArray(ae.vao),e.uniform1i(ae.program.uniformLocations.u_image,0),e.uniform1f(ae.program.uniformLocations.u_percentage,a),e.uniform2f(ae.program.uniformLocations.u_velocity,l.velocityX,l.velocityY),e.drawArrays(e.TRIANGLE_STRIP,0,4),!0}const ye=`#version 300 es

in vec2 a_clipCoord;
in vec2 a_texCoord;

// progress of the animation, 0.0 - 1.0
uniform float u_percentage;

// maximum height (attained at start/end of animation), 0.0 - 1.0
uniform float u_jumpHeight;

// time spent on the ground, deforming, 0.0 - 1.0
uniform float u_groundTime;

// maximum percentage deformation (attainted at 0.5), 0.0 - 1.0
uniform vec2 u_maxDeform;

out vec2 v_texCoord;

void main() {
  float airTime = min(u_percentage, 1.0 - u_percentage) * 2.0 / (1.0 - u_groundTime);
  if (airTime < 1.0) {
    // mid air
    float h = (1.0 - airTime * airTime) * u_jumpHeight * 2.0;
    gl_Position = vec4(a_clipCoord.x, a_clipCoord.y - h, 0, 1);
    v_texCoord = vec2(a_texCoord.x, a_texCoord.y);
  } else {
    // on the ground, deforming
    float groundTime = abs(0.5 - u_percentage) * 2.0 / u_groundTime;
    vec2 deformCoef = (1.0 - groundTime * groundTime) * u_maxDeform;
    float y = 1.0 - (1.0 - a_clipCoord.y) * (1.0 - deformCoef.y);
    gl_Position = vec4(a_clipCoord.x, y, 0, 1);

    float offsetX = abs(a_texCoord.x - 0.5) * (1.0 - abs(a_clipCoord.y)) * deformCoef.x;
    float x = a_texCoord.x > 0.5 ? a_texCoord.x - offsetX : a_texCoord.x + offsetX;
    v_texCoord = vec2(x, a_texCoord.y);
  }
}
`,be=`#version 300 es

precision highp float;

in vec2 v_texCoord;
uniform sampler2D u_image;

out vec4 outColor;

void main() {
  outColor = texture(u_image, v_texCoord);
}
`;let $={initialized:!1};function Ee(e){if(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),$.initialized)return;const a=ue(e,ye,be,["a_texCoord","a_clipCoord"],["u_percentage","u_jumpHeight","u_groundTime","u_maxDeform","u_image"]);if(!a)throw new Error("Failed to compile the program");const l=e.createVertexArray();if(!l)throw new Error("Failed to create vertex array object");e.bindVertexArray(l);const d=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,d),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,.5,.5,-1,-1,0,0,0,-1,.5,0,1,-1,1,0,1,0,1,.5,1,1,1,1,0,1,.5,1,-1,1,0,1,-1,0,0,.5,-1,-1,0,0]),e.STATIC_DRAW),e.enableVertexAttribArray(a.attributeLocations.a_clipCoord),e.vertexAttribPointer(a.attributeLocations.a_clipCoord,2,e.FLOAT,!1,4*4,0),e.enableVertexAttribArray(a.attributeLocations.a_texCoord),e.vertexAttribPointer(a.attributeLocations.a_texCoord,2,e.FLOAT,!1,4*4,2*4),$={initialized:!0,program:a,vao:l}}function Te(e,a,l){if(!$.initialized)throw new Error("Animation has not been initialized: extreme-speed");return e.useProgram($.program.program),e.bindVertexArray($.vao),e.uniform1i($.program.uniformLocations.u_image,0),e.uniform1f($.program.uniformLocations.u_percentage,a),e.uniform1f($.program.uniformLocations.u_jumpHeight,l.jumpHeight),e.uniform1f($.program.uniformLocations.u_groundTime,l.groundTime),e.uniform2f($.program.uniformLocations.u_maxDeform,l.maxDeformX,l.maxDeformY),e.drawArrays(e.TRIANGLE_FAN,0,10),!0}const se=new OffscreenCanvas(128,128),x=se.getContext("webgl2");let fe=null;self.onmessage=async e=>{const a=e.data;if(!x){const F={id:a.id,type:"error",error:"webgl2 is not supported"};postMessage(F);return}const d=await(await fetch(a.gif.imageUrl)).blob(),y=await createImageBitmap(d);fe&&x.deleteTexture(fe),fe=x.createTexture(),x.activeTexture(x.TEXTURE0+0),x.bindTexture(x.TEXTURE_2D,fe),x.texImage2D(x.TEXTURE_2D,0,x.RGBA,x.RGBA,x.UNSIGNED_BYTE,y),se.width=a.gif.width,se.height=a.gif.height;try{switch(a.animation.name){case"extreme-speed":_e(x);break;case"jumping":Ee(x);break;default:(F=>{throw new Error("Unknown animation")})(a.animation)}}catch(F){const A={id:a.id,type:"error",error:String(F)};postMessage(A);return}const m=new le;m.setRepeat(0),m.setDelay(a.gif.delayMs),m.setSize(a.gif.width,a.gif.height),m.start();for(let F=0;F<=a.gif.totalFrames;++F){x.viewport(0,0,x.canvas.width,x.canvas.height),x.clearColor(0,0,0,0),x.clear(x.COLOR_BUFFER_BIT);try{switch(a.animation.name){case"extreme-speed":we(x,F/a.gif.totalFrames,a.animation);break;case"jumping":Te(x,F/a.gif.totalFrames,a.animation);break;default:(v=>{throw new Error("Unknown animation")})(a.animation)}}catch(v){const U={id:a.id,type:"error",error:String(v)};postMessage(U);return}const A=new Uint8ClampedArray(x.drawingBufferWidth*x.drawingBufferHeight*4);x.readPixels(0,0,x.drawingBufferWidth,x.drawingBufferHeight,x.RGBA,x.UNSIGNED_BYTE,A),m.addFrame(A,!0)}m.finish();const S=m.stream().getData(),L="data:image/gif;base64,"+btoa(S),g={id:a.id,type:"success",dataUri:L};postMessage(g)}})();
